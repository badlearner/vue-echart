define(["require","exports","esri/map","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/GraphicsLayer","esri/symbols/PictureMarkerSymbol","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/Color","esri/dijit/LayerList","esri/tasks/QueryTask","esri/tasks/query","esri/tasks/FindTask","esri/tasks/FindParameters","esri/tasks/StatisticDefinition","esri/layers/FeatureLayer","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","../../config/mapConfig","dojo/_base/lang"],function(e,r,i,t,a,n,o,s,l,y,u,d,c,m,f,b,S,v,p,g,h,L){"use strict";return function(){function r(){}return r.initMap=function(e,r){void 0===e&&(e="mapDiv");var t={divId:e,options:{lods:h.lods,logo:!1,zoom:0,slider:!1,showLabels:!0}};return L.mixin(t.options,r),-1===t.options.zoom&&delete t.options.zoom,new i(t.divId,t.options)},r.loadMapServerLayers=function(e,r,i){var n=this;void 0===i&&(i=this.map),r.forEach(function(r){var o,s={},l={};for(var y in r){if(r.hasOwnProperty(y)&&(s[y]=r[y]),!(l=e.layers[s.name]))return void console.log("加载图层时，未在配置文件中找到图层："+s.name);s.id=l.text}switch(l.type){case"tile":o=new a(l.url,s);break;default:o=new t(l.url,s)}o.on("load",function(e){for(var r in l.lyr=e.layer,l.sublayerIds)l.sublayerIds.hasOwnProperty(r)&&(l.sublayerIds[r]=n.getSubLayerIdFromMapServer(e.layer,l.sublayerIds[r]))}),i.addLayer(o)})},r.initLayerList=function(e,r,i,t){void 0===e&&(e="layerList"),void 0===i&&(i=this.map),void 0===t&&(t=[]);var a={map:i,showLegend:!0,showOpacitySlider:!0,layers:[]};L.mixin(a,r),t.length&&(i.layerIds.forEach(function(e){-1===t.indexOf(e)&&a.layers.push({layer:i.getLayer(e),showSubLayers:!0,showLegend:!0,showOpacitySlider:!0,id:i.getLayer(e).id})}),i.graphicsLayerIds.forEach(function(e){-1===t.indexOf(e)&&a.layers.push({layer:i.getLayer(e),showOpacitySlider:!0,id:i.getLayer(e).id})}));var n=new d(a,e);return n.startup(),n},r.getQueryTask=function(e){if(e)return new c(e);console.warn("url="+e+"无法生成queryTask")},r.getQuery=function(e){var r=new m;return L.mixin(r,e),r},r.getFindTask=function(e){if(e)return new f(e);console.warn("url="+e+"无法生成queryTask")},r.getFindParameters=function(e){var r=new b;return L.mixin(r,e),r},r.getIdentifyParameters=function(e){var r=new g;return r.tolerance=3,r.layerOption=g.LAYER_OPTION_VISIBLE,L.mixin(r,e)},r.getIdentifyTask=function(e){if(e)return new p(e);console.warn("url="+e+"无法生成IdentifyTask")},r.getStatisticDefinition=function(e,r){if(e&&r){var i=new S;return i.statisticType=e,i.onStatisticField=r,i.outStatisticFieldName=e,i}console.warn("StatisticDefinition 缺少参数")},r.getImportantLayers=function(e,r){void 0===r&&(r=this.map);var i={};for(var t in e)if(e.hasOwnProperty(t)){var a=this.getLayerIdFromLoadLayers(t);for(var n in a.sublayerIds)if(a.sublayerIds.hasOwnProperty(n)){var o=a.sublayerIds[n];a.sublayerIds[n]=this.getSubLayerIdFromMapServer(a.lyr,o)}i[t]=a}return i},r.getGraphicsLayer=function(e){return new n(e)},r.getFeatureLayer=function(e,r){return new v(e,r)},r.setGraphicLayerMouseEvent=function(e,r,i){var t=this;e.on("mouse-over",function(e){t.exchangeGraphicsSymbol(e.graphic,r)}),e.on("mouse-out",function(e){t.exchangeGraphicsSymbol(e.graphic,i)})},r.setGraphicLayerDefaultSymbol=function(e,r){var i=this;return e.on("graphic-add",function(e){var t=e.graphic;if(r)t.setSymbol(r);else if(!t.symbol){var a;switch(t.geometry.type){case"polygon":case"extent":a=i.getFillSymbol();break;case"polyline":a=i.getLineSymbol();break;case"point":a=i.getMarkerSymbol()}t.setSymbol(a)}})},r.getFillSymbol=function(e,r,i){void 0===e&&(e=l.STYLE_SOLID),void 0===r&&(r=this.getLineSymbol()),void 0===i&&(i=[255,0,0,0]);var t=(new l).setColor(new u([255,0,0,0])).setOutline(r);return e!==l.STYLE_SOLID&&t.setStyle(e),t},r.getLineSymbol=function(e,r,i){return void 0===e&&(e=y.STYLE_SOLID),void 0===r&&(r="#FF0000"),void 0===i&&(i=2),(new y).setStyle(e).setColor(new u(r)).setWidth(i)},r.getMarkerSymbol=function(e,r,i,t){return void 0===e&&(e=s.STYLE_CIRCLE),void 0===r&&(r=15),void 0===i&&(i=this.getLineSymbol(y.STYLE_SOLID,[255,127,127,1],3)),void 0===t&&(t=[255,0,0,1]),new s(e,r,i,t)},r.getPictureMakerSymbol=function(r,i,t){return void 0===r&&(r=e.toUrl("image/symbol/PointRed.png")),void 0===i&&(i=21),void 0===t&&(t=33),new o(r,i,t)},r.exchangeGraphicsSymbol=function(r,i){if(i){var t=r.symbol;return r.setSymbol(i),void(r.beforeSymbol=t)}if(r.beforeSymbol){var a=r.symbol;return r.setSymbol(r.beforeSymbol),void(r.beforeSymbol=a)}var n;switch(r.geometry.type){case"polygon":case"extent":(n=this.getFillSymbol()).outline.setColor(new u("#00FFFF"));break;case"polyline":(n=this.getLineSymbol()).setColor(new u("#00FFFF"));break;case"point":n="simplemarkersymbol"===r.symbol.type?this.getMarkerSymbol("circle",28,this.getLineSymbol("solid",[0,92,230,.3137],11),[0,112,255,1]):this.getPictureMakerSymbol(e.toUrl("image/symbol/PointBlue.png")).setOffset(0,15)}var o=r.symbol;r.setSymbol(n),r.beforeSymbol=o},r.getLayerIdFromLoadLayers=function(e,r,i){void 0===r&&(r=this.map),void 0===i&&(i=this.pageName);var t=new RegExp(e,"i"),a=h.pageInfos[i].loadLayers.filter(function(e){return t.test(e.name)});if(a.length){var n=h.layers[a[0].name];return{lyr:r.getLayer(n.text),sublayerIds:n.sublayerIds}}console.warn("未能在mapconfig.Infos."+i+".loadLayers找到"+e+"地图,请修改配置")},r.getSubLayerIdFromMapServer=function(e,r){if(e.hasOwnProperty("layerInfos")){var i=-1;return e.layerInfos.forEach(function(e){e.name===r&&(-1!==i&&console.warn("出现多个一样名字一样的图层 ："+r+" layerId 为"+i+","+e.id),i=e.id)}),i}},r.calculateHeatmapMaxPixelIntensity=function(e,i,t){void 0===i&&(i=!1),void 0===t&&(t=2);var a=e.renderer;e.queryFeatures({outStatistics:[r.getStatisticDefinition("max",a.field),r.getStatisticDefinition("stddev",a.field)]}).then(function(r){if(r.features.length>0){var n=r.features[0].attributes,o=(n.MAX||n.max)-(n.STDDEV||n.stddev);o&&(a.maxPixelIntensity=o*t),i&&e.redraw()}})},r}()});